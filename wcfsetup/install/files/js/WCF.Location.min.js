WCF.Location={},WCF.Location.Util={getLocation:function(e,t){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e(t.coords.latitude,t.coords.longitude)},function(){e(void 0,void 0)},{timeout:t||5e3}):e(void 0,void 0)}},WCF.Location.GoogleMaps={},WCF.Location.GoogleMaps.Settings={_settings:{},get:function(e){return void 0===e?this._settings:void 0!==this._settings[e]?this._settings[e]:null},set:function(e,t){if($.isPlainObject(e))for(var o in e)this._settings[o]=e[o];else this._settings[e]=t}},WCF.Location.GoogleMaps.Map=Class.extend({_map:null,_markers:[],init:function(e,t){this._mapContainer=$("#"+e),this._mapOptions=$.extend(!0,this._getDefaultMapOptions(),t),this._map=new google.maps.Map(this._mapContainer[0],this._mapOptions),this._markers=[],this._mapContainer.parents(".sidebar").length&&enquire.register("screen and (max-width: 800px)",{setup:$.proxy(this._addSidebarMapListener,this),deferSetup:!0}),this.refresh()},_addInfoWindowEventListener:function(e,t){google.maps.event.addListener(e,"click",$.proxy(function(){t.open(this._map,e)},this))},_addSidebarMapListener:function(){$(".content > .mobileSidebarToggleButton").click($.proxy(this.refresh,this))},_getDefaultMapOptions:function(){var e={};switch(e.center=new google.maps.LatLng(WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude")),e.disableDoubleClickZoom=WCF.Location.GoogleMaps.Settings.get("disableDoubleClickZoom"),e.draggable=WCF.Location.GoogleMaps.Settings.get("draggable"),WCF.Location.GoogleMaps.Settings.get("mapType")){case"map":e.mapTypeId=google.maps.MapTypeId.ROADMAP;break;case"satellite":e.mapTypeId=google.maps.MapTypeId.SATELLITE;break;case"physical":e.mapTypeId=google.maps.MapTypeId.TERRAIN;break;case"hybrid":default:e.mapTypeId=google.maps.MapTypeId.HYBRID}if(e.mapTypeControl="off"!=WCF.Location.GoogleMaps.Settings.get("mapTypeControl"),e.mapTypeControl)switch(WCF.Location.GoogleMaps.Settings.get("mapTypeControl")){case"dropdown":e.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DROPDOWN_MENU};break;case"horizontalBar":e.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR};break;default:e.mapTypeControlOptions={style:google.maps.MapTypeControlStyle.DEFAULT}}return e.scaleControl=WCF.Location.GoogleMaps.Settings.get("scaleControl"),e.scrollwheel=WCF.Location.GoogleMaps.Settings.get("scrollwheel"),e.zoom=WCF.Location.GoogleMaps.Settings.get("zoom"),e},addDraggableMarker:function(e,t){var o=new google.maps.Marker({clickable:!1,draggable:!0,map:this._map,position:new google.maps.LatLng(e,t),zIndex:1});return this._markers.push(o),o},addMarker:function(e,t,o,a,i){var s=new google.maps.Marker({map:this._map,position:new google.maps.LatLng(e,t),title:o});if(a&&s.setIcon(a),i){var n=new google.maps.InfoWindow({content:i});this._addInfoWindowEventListener(s,n),s.infoWindow=n}return this._markers.push(s),s},getMarkers:function(){return this._markers},getMap:function(){return this._map},refresh:function(){var e=this._map.getCenter();google.maps.event.trigger(this._map,"resize"),this._map.setCenter(e)},refreshBounds:function(){var e=null,t=null,o=null,a=null;for(var i in this._markers){var s=this._markers[i],n=s.getPosition().lat(),r=s.getPosition().lng();null===e?(e=t=n,o=a=r):(e>n?e=n:n>t&&(t=n),o>n?o=n:r>a&&(a=r))}this._map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(e,o),new google.maps.LatLng(t,a)))},removeMarkers:function(){for(var e in this._markers)this._markers[e].setMap(null);this._markers=[]},setCenter:function(e,t){this._map.setCenter(new google.maps.LatLng(e,t))}}),WCF.Location.GoogleMaps.LargeMap=WCF.Location.GoogleMaps.Map.extend({_actionClassName:null,_locationSearch:null,_locationSearchInputSelector:null,_markerClusterer:null,_objectIDs:[],_previousNorthEast:null,_previousSouthWest:null,init:function(e,t,o,a){this._super(e,t),this._actionClassName=o,this._locationSearchInputSelector=a||"",this._objectIDs=[],this._locationSearchInputSelector&&(this._locationSearch=new WCF.Location.GoogleMaps.LocationSearch(a,$.proxy(this._centerMap,this))),this._markerClusterer=new MarkerClusterer(this._map,this._markers,{maxZoom:17}),this._markerSpiderfier=new OverlappingMarkerSpiderfier(this._map,{keepSpiderfied:!0,markersWontHide:!0,markersWontMove:!0}),this._markerSpiderfier.addListener("click",$.proxy(function(e){e.infoWindow&&e.infoWindow.open(this._map,e)},this)),this._proxy=new WCF.Action.Proxy({showLoadingOverlay:!1,success:$.proxy(this._success,this)}),this._previousNorthEast=null,this._previousSouthWest=null,google.maps.event.addListener(this._map,"idle",$.proxy(this._loadMarkers,this))},_addInfoWindowEventListener:function(){},_centerMap:function(e){this.setCenter(e.location.lat(),e.location.lng()),$(this._locationSearchInputSelector).val(e.label)},_loadMarkers:function(){var e=this._map.getBounds().getNorthEast(),t=this._map.getBounds().getSouthWest();this._previousNorthEast&&this._previousNorthEast.lat()>=e.lat()&&this._previousNorthEast.lng()>=e.lng()&&this._previousSouthWest.lat()<=t.lat()&&this._previousSouthWest.lng()<=t.lng()||(this._previousNorthEast=e,this._previousSouthWest=t,this._proxy.setOption("data",{actionName:"getMapMarkers",className:this._actionClassName,parameters:{excludedObjectIDs:this._objectIDs,eastLongitude:e.lng(),northLatitude:e.lat(),southLatitude:t.lat(),westLongitude:t.lng()}}),this._proxy.sendRequest())},_success:function(e){if(e.returnValues&&e.returnValues.markers)for(var t in e.returnValues.markers){var o=e.returnValues.markers[t];this.addMarker(o.latitude,o.longitude,o.title,null,o.infoWindow),o.objectID?this._objectIDs.push(o.objectID):o.objectIDs&&(this._objectIDs=this._objectIDs.concat(o.objectIDs))}},addMarker:function(e,t,o,a,i){var s=this._super(e,t,o,a,i);return this._markerClusterer.addMarker(s),this._markerSpiderfier.addMarker(s),s}}),WCF.Location.GoogleMaps.LocationSearch=WCF.Search.Base.extend({_geocoder:null,init:function(e,t,o,a,i){this._super(e,t,o,a,i),this._geocoder=new google.maps.Geocoder},_createListItem:function(e){var t=$("<li><span>"+WCF.String.escapeHTML(e.formatted_address)+"</span></li>").appendTo(this._list);return t.data("location",e.geometry.location).data("label",e.formatted_address).click($.proxy(this._executeCallback,this)),this._itemCount++,t},_keyUp:function(e){switch(e.which){case $.ui.keyCode.LEFT:case $.ui.keyCode.RIGHT:return;case $.ui.keyCode.UP:return void this._selectPreviousItem();case $.ui.keyCode.DOWN:return void this._selectNextItem();case $.ui.keyCode.ENTER:return this._selectElement(e)}var t=this._getSearchString(e);""===t?this._clearList(!0):t.length>=this._triggerLength?this._geocoder.geocode({address:t},$.proxy(this._success,this)):this._clearList(!1)},_success:function(e,t){if(this._clearList(!1),t==google.maps.GeocoderStatus.OK){if($.getLength(e)){var o=0;for(var a in e)if(this._createListItem(e[a]),10==++o)break}else if(!this._handleEmptyResult())return;WCF.CloseOverlayHandler.addCallback("WCF.Search.Base",$.proxy(function(){this._clearList()},this));var i=this._searchInput.parents(".dropdown").wcfIdentify();WCF.Dropdown.getDropdownMenu(i).hasClass("dropdownOpen")||WCF.Dropdown.toggleDropdown(i),this._itemIndex=-1,WCF.Dropdown.getDropdown(i).data("disableAutoFocus")||this._selectNextItem()}}}),WCF.Location.GoogleMaps.LocationInput=Class.extend({_locationSearch:null,_map:null,_marker:null,init:function(e,t,o,a,i){this._searchInput=o,this._map=new WCF.Location.GoogleMaps.Map(e,t),this._locationSearch=new WCF.Location.GoogleMaps.LocationSearch(o,$.proxy(this._setMarkerByLocation,this)),a&&i?this._marker=this._map.addDraggableMarker(a,i):(this._marker=this._map.addDraggableMarker(WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude")),WCF.Location.Util.getLocation($.proxy(function(e,t){void 0!==e&&void 0!==t&&(WCF.Location.GoogleMaps.Util.moveMarker(this._marker,e,t),WCF.Location.GoogleMaps.Util.focusMarker(this._marker))},this))),this._marker.addListener("dragend",$.proxy(this._updateLocation,this))},getMap:function(){return this._map},getMarker:function(){return this._marker},_updateLocation:function(){WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(function(e){null!==e&&$(this._searchInput).val(e)},this),this._marker)},_setMarkerByLocation:function(e){this._marker.setPosition(e.location),WCF.Location.GoogleMaps.Util.focusMarker(this._marker),$(this._searchInput).val(e.label)}}),WCF.Location.GoogleMaps.Util={_geocoder:null,focusMarker:function(e){e.getMap().setCenter(e.getPosition())},getMarkerPosition:function(e){return{latitude:e.getPosition().lat(),longitude:e.getPosition().lng()}},moveMarker:function(e,t,o,a){e.setPosition(new google.maps.LatLng(t,o)),a&&google.maps.event.trigger(e,"dragend")},reverseGeocoding:function(e,t,o,a,i){t&&(o=t.getPosition().lat(),a=t.getPosition().lng()),null===this._geocoder&&(this._geocoder=new google.maps.Geocoder);var s=new google.maps.LatLng(o,a);this._geocoder.geocode({latLng:s},function(t,o){e(o==google.maps.GeocoderStatus.OK?i?t:t[0].formatted_address:null)})}};